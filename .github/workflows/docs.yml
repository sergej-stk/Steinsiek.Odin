name: API Documentation

on:
  push:
    branches: [main]
    paths:
      - 'src/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-docs:
    name: Generate API Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: nuget-${{ runner.os }}-

      - run: dotnet restore --locked-mode

      - name: Build and generate OpenAPI spec
        run: dotnet build --no-restore
        env:
          ConnectionStrings__cache: "localhost:0,abortConnect=false,connectTimeout=1"

      - name: Copy OpenAPI spec to docs
        run: |
          mkdir -p docs
          cp src/Steinsiek.Odin.API/obj/Steinsiek.Odin.API.json docs/openapi.json

      - name: Commit updated docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/openapi.json
          git diff --staged --quiet || (git commit -m "Update API documentation" && git push)
