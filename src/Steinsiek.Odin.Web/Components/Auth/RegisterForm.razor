@inject IAuthApiClient AuthApi
@inject ITokenStorageService TokenStorage
@inject JwtAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudForm @ref="_form" @bind-IsValid="_isValid">
    <MudStack Spacing="3">
        <ErrorAlert Message="@_errorMessage" Visible="@(_errorMessage is not null)" />
        <MudStack Row="true" Spacing="2">
            <MudTextField T="string" @bind-Value="_firstName" Label="First Name" Required="true"
                          RequiredError="First name is required" Variant="Variant.Outlined" />
            <MudTextField T="string" @bind-Value="_lastName" Label="Last Name" Required="true"
                          RequiredError="Last name is required" Variant="Variant.Outlined" />
        </MudStack>
        <MudTextField T="string" @bind-Value="_email" Label="Email" Required="true"
                      RequiredError="Email is required" InputType="InputType.Email"
                      Variant="Variant.Outlined" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Email" />
        <MudTextField T="string" @bind-Value="_password" Label="Password" Required="true"
                      RequiredError="Password is required"
                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                      Variant="Variant.Outlined" Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="@(() => _showPassword = !_showPassword)"
                      Validation="@(new Func<string, string?>(ValidatePassword))" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                   Size="Size.Large" Disabled="@(!_isValid || _isLoading)"
                   OnClick="@HandleRegister">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Create Account
        </MudButton>
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
            Already have an account?
            <MudLink Href="/login" Typo="Typo.body2">Login here</MudLink>
        </MudText>
    </MudStack>
</MudForm>

@code {
    private MudForm _form = default!;
    private bool _isValid;
    private bool _isLoading;
    private bool _showPassword;
    private string _firstName = string.Empty;
    private string _lastName = string.Empty;
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string? _errorMessage;

    private async Task HandleRegister()
    {
        await _form.Validate();
        if (!_isValid)
        {
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        var request = new RegisterRequest
        {
            Email = _email,
            Password = _password,
            FirstName = _firstName,
            LastName = _lastName
        };

        var result = await AuthApi.Register(request, CancellationToken.None);

        if (result is not null)
        {
            await TokenStorage.SetToken(result.Token, CancellationToken.None);
            AuthStateProvider.NotifyAuthenticationStateChanged();
            Snackbar.Add($"Welcome, {result.User.FirstName}! Account created successfully.", Severity.Success);
            Navigation.NavigateTo("/");
        }
        else
        {
            _errorMessage = "Registration failed. The email may already be in use.";
        }

        _isLoading = false;
    }

    private static string? ValidatePassword(string password)
    {
        if (string.IsNullOrEmpty(password))
        {
            return "Password is required";
        }

        if (password.Length < 6)
        {
            return "Password must be at least 6 characters";
        }

        return null;
    }
}
