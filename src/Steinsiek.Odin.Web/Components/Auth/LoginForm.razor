@inject IAuthApiClient AuthApi
@inject ITokenStorageService TokenStorage
@inject JwtAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudForm @ref="_form" @bind-IsValid="_isValid">
    <MudStack Spacing="3">
        <ErrorAlert Message="@_errorMessage" Visible="@(_errorMessage is not null)" />
        <MudTextField T="string" @bind-Value="_email" Label="Email" Required="true"
                      RequiredError="Email is required" InputType="InputType.Email"
                      Variant="Variant.Outlined" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Email" />
        <MudTextField T="string" @bind-Value="_password" Label="Password" Required="true"
                      RequiredError="Password is required"
                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                      Variant="Variant.Outlined" Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="@(() => _showPassword = !_showPassword)" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                   Size="Size.Large" Disabled="@(!_isValid || _isLoading)"
                   OnClick="@HandleLogin">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Login
        </MudButton>
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
            Don't have an account?
            <MudLink Href="/register" Typo="Typo.body2">Register here</MudLink>
        </MudText>
    </MudStack>
</MudForm>

@code {
    private MudForm _form = default!;
    private bool _isValid;
    private bool _isLoading;
    private bool _showPassword;
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string? _errorMessage;

    /// <summary>
    /// The URL to redirect to after successful login.
    /// </summary>
    [Parameter]
    public string? ReturnUrl { get; set; }

    private async Task HandleLogin()
    {
        await _form.Validate();
        if (!_isValid)
        {
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        var request = new LoginRequest { Email = _email, Password = _password };
        var result = await AuthApi.Login(request, CancellationToken.None);

        if (result is not null)
        {
            await TokenStorage.SetToken(result.Token, CancellationToken.None);
            AuthStateProvider.NotifyAuthenticationStateChanged();
            Snackbar.Add($"Welcome back, {result.User.FirstName}!", Severity.Success);
            Navigation.NavigateTo(ReturnUrl ?? "/");
        }
        else
        {
            _errorMessage = "Invalid email or password. Please try again.";
        }

        _isLoading = false;
    }
}
