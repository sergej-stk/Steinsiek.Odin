@if (TotalCount > 0 || ShowPageSizeSelector)
{
    <nav aria-label="Page navigation">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <small class="text-muted">Showing @StartItem-@EndItem of @TotalCount</small>
                @if (SelectedCount > 0)
                {
                    <span class="badge bg-secondary">@SelectedCount selected</span>
                }
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(CurrentPage <= 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage - 1)" disabled="@(CurrentPage <= 1)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                    </li>
                    @foreach (var pageNumber in GetPageNumbers())
                    {
                        var current = pageNumber;
                        <li class="page-item @(current == CurrentPage ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(current)">@current</button>
                        </li>
                    }
                    <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(CurrentPage + 1)" disabled="@(CurrentPage >= TotalPages)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </div>
            @if (ShowPageSizeSelector)
            {
                <select class="form-select form-select-sm d-print-none" style="width: auto;"
                        value="@PageSize" @onchange="HandlePageSizeChange">
                    @foreach (var size in PageSizeOptions)
                    {
                        <option value="@size">@size per page</option>
                    }
                </select>
            }
        </div>
    </nav>
}

@code {
    /// <summary>
    /// The total number of items across all pages.
    /// </summary>
    [Parameter]
    public int TotalCount { get; set; }

    /// <summary>
    /// The number of items displayed per page.
    /// </summary>
    [Parameter]
    public int PageSize { get; set; } = 25;

    /// <summary>
    /// The currently active page number (1-based).
    /// </summary>
    [Parameter]
    public int CurrentPage { get; set; } = 1;

    /// <summary>
    /// Callback invoked when the user navigates to a different page.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnPageChanged { get; set; }

    /// <summary>
    /// Whether to show the page size dropdown selector.
    /// </summary>
    [Parameter]
    public bool ShowPageSizeSelector { get; set; }

    /// <summary>
    /// The available page size options.
    /// </summary>
    [Parameter]
    public int[] PageSizeOptions { get; set; } = [25, 50, 100];

    /// <summary>
    /// Callback invoked when the user changes the page size.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnPageSizeChanged { get; set; }

    /// <summary>
    /// The number of currently selected items to display as a badge.
    /// </summary>
    [Parameter]
    public int SelectedCount { get; set; }

    /// <summary>
    /// The total number of pages calculated from total count and page size.
    /// </summary>
    private int TotalPages => PageSize > 0 ? (int)Math.Ceiling((double)TotalCount / PageSize) : 0;

    /// <summary>
    /// The 1-based index of the first item on the current page.
    /// </summary>
    private int StartItem => TotalCount > 0 ? (CurrentPage - 1) * PageSize + 1 : 0;

    /// <summary>
    /// The 1-based index of the last item on the current page.
    /// </summary>
    private int EndItem => Math.Min(CurrentPage * PageSize, TotalCount);

    /// <summary>
    /// Navigates to the specified page if it is valid and different from the current page.
    /// </summary>
    /// <param name="page">The target page number.</param>
    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages && page != CurrentPage)
        {
            await OnPageChanged.InvokeAsync(page);
        }
    }

    /// <summary>
    /// Handles the page size dropdown change event.
    /// </summary>
    private async Task HandlePageSizeChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newSize))
        {
            await OnPageSizeChanged.InvokeAsync(newSize);
        }
    }

    /// <summary>
    /// Calculates the visible page numbers centered around the current page.
    /// </summary>
    /// <returns>A sequence of page numbers to display.</returns>
    private IEnumerable<int> GetPageNumbers()
    {
        if (TotalPages <= 0)
        {
            return Enumerable.Range(1, 1);
        }

        var start = Math.Max(1, CurrentPage - 2);
        var end = Math.Min(TotalPages, CurrentPage + 2);

        if (end - start < 4)
        {
            start = Math.Max(1, end - 4);
            end = Math.Min(TotalPages, start + 4);
        }

        return Enumerable.Range(start, end - start + 1);
    }
}
