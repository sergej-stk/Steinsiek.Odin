@implements IDisposable

<div class="input-group" style="max-width: 300px;">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" class="form-control" placeholder="Search..." @bind="SearchTerm" @bind:event="oninput" @onkeyup="OnKeyUp" />
    @if (!string.IsNullOrEmpty(SearchTerm))
    {
        <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
            <i class="bi bi-x-lg"></i>
        </button>
    }
</div>

@code {
    /// <summary>
    /// Callback invoked when the search term changes after debounce.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnSearch { get; set; }

    /// <summary>
    /// The debounce delay in milliseconds before triggering the search callback.
    /// </summary>
    [Parameter]
    public int DebounceMilliseconds { get; set; } = 300;

    /// <summary>
    /// The current search term entered by the user.
    /// </summary>
    private string SearchTerm { get; set; } = "";

    /// <summary>
    /// Timer used to debounce the search input.
    /// </summary>
    private System.Timers.Timer? _debounceTimer;

    /// <summary>
    /// Handles the key up event by resetting the debounce timer and scheduling a search callback.
    /// </summary>
    private void OnKeyUp()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Timers.Timer(DebounceMilliseconds);
        _debounceTimer.Elapsed += async (_, _) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(() => OnSearch.InvokeAsync(SearchTerm));
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }

    /// <summary>
    /// Clears the search term and immediately triggers the search callback with an empty string.
    /// </summary>
    private async Task ClearSearch()
    {
        SearchTerm = "";
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        await OnSearch.InvokeAsync("");
    }

    /// <inheritdoc />
    public void Dispose()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
    }
}
