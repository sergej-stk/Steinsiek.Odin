@page "/products/{Id:guid}"
@inject IProductApiClient ProductApi
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>@(_product?.Name ?? "Product") - Odin</PageTitle>

@if (_product is null && !_notFound)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_notFound)
{
    <MudPaper Class="pa-8 text-center" Elevation="0">
        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Color="Color.Error" Class="mb-4" />
        <MudText Typo="Typo.h5">Product not found</MudText>
        <MudButton Href="/products" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">
            Back to Products
        </MudButton>
    </MudPaper>
}
else if (_product is not null)
{
    <PageHeader Title="@_product.Name">
        <Actions>
            <AuthorizeView>
                <Authorized>
                    <MudButton Href="@($"/products/{_product.Id}/edit")" Variant="Variant.Outlined"
                               Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit">
                        Edit
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.Delete" OnClick="@HandleDelete"
                               Class="ml-2">
                        Delete
                    </MudButton>
                </Authorized>
            </AuthorizeView>
        </Actions>
    </PageHeader>

    <MudGrid>
        <MudItem xs="12" md="5">
            <MudPaper Class="rounded-lg overflow-hidden" Elevation="2">
                @if (!string.IsNullOrEmpty(_product.ImageUrl))
                {
                    <MudImage Src="@_product.ImageUrl" Alt="@_product.Name"
                              ObjectFit="ObjectFit.Cover" Width="100" Height="400"
                              Class="rounded-lg" Style="width: 100%;" />
                }
                else
                {
                    <MudPaper Height="400px" Class="d-flex align-center justify-center"
                              Style="background: linear-gradient(135deg, var(--mud-palette-primary-lighten), var(--mud-palette-secondary-lighten));">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Style="font-size: 5rem; opacity: 0.5;" />
                    </MudPaper>
                }
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="7">
            <MudStack Spacing="3">
                @if (!string.IsNullOrEmpty(_product.CategoryName))
                {
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined"
                             Icon="@Icons.Material.Filled.Category">
                        @_product.CategoryName
                    </MudChip>
                }

                <MudText Typo="Typo.h3" Color="Color.Primary" Style="font-weight: 700;">
                    @_product.Price.ToString("C2")
                </MudText>

                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    @if (_product.Stock > 0)
                    {
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.CheckCircle">
                            In Stock (@_product.Stock available)
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Filled"
                                 Icon="@Icons.Material.Filled.RemoveCircle">
                            Out of Stock
                        </MudChip>
                    }
                    @if (!_product.IsActive)
                    {
                        <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled">Inactive</MudChip>
                    }
                </MudStack>

                @if (!string.IsNullOrEmpty(_product.Description))
                {
                    <MudDivider />
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Description</MudText>
                    <MudText Typo="Typo.body1">@_product.Description</MudText>
                }

                <MudDivider />
                <MudButton Href="/products" Variant="Variant.Text" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.ArrowBack">
                    Back to Products
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {
    private ProductDto? _product;
    private bool _notFound;

    /// <summary>
    /// The product identifier from the route.
    /// </summary>
    [Parameter]
    public Guid Id { get; set; }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        _product = await ProductApi.GetById(Id, CancellationToken.None);
        if (_product is null)
        {
            _notFound = true;
        }
    }

    private async Task HandleDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Are you sure you want to delete \"{_product!.Name}\"? This action cannot be undone." },
            { x => x.ButtonText, "Delete" },
            { x => x.ButtonColor, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Product", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            var success = await ProductApi.Delete(_product.Id, CancellationToken.None);
            if (success)
            {
                Snackbar.Add("Product deleted successfully", Severity.Success);
                Navigation.NavigateTo("/products");
            }
            else
            {
                Snackbar.Add("Failed to delete product", Severity.Error);
            }
        }
    }
}
