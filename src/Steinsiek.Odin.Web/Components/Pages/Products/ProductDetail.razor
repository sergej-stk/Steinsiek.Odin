@page "/products/{Id:guid}"
@inject IProductApiClient ProductApi
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>@(_product?.Name ?? "Product") - Odin</PageTitle>

@if (_product is null && !_notFound)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_notFound)
{
    <div class="text-center py-5">
        <i class="bi bi-exclamation-circle text-danger fs-1 mb-3 d-block"></i>
        <h5>Product not found</h5>
        <a href="/products" class="btn btn-primary mt-3">Back to Products</a>
    </div>
}
else if (_product is not null)
{
    <PageHeader Title="@_product.Name">
        <Actions>
            <AuthorizeView>
                <Authorized>
                    <a href="/products/@(_product.Id)/edit" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </a>
                    <button class="btn btn-danger ms-2" @onclick="@(() => _showDeleteConfirm = true)">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </Authorized>
            </AuthorizeView>
        </Actions>
    </PageHeader>

    <div class="row g-4">
        <div class="col-12 col-md-5">
            <div class="card overflow-hidden">
                @if (!string.IsNullOrEmpty(_product.ImageUrl))
                {
                    <img src="@_product.ImageUrl" alt="@_product.Name" class="card-img-top" style="height: 400px; object-fit: cover;" />
                }
                else
                {
                    <div class="placeholder-image" style="height: 400px;">
                        <i class="bi bi-bag" style="font-size: 5rem;"></i>
                    </div>
                }
            </div>
        </div>
        <div class="col-12 col-md-7">
            <div class="d-flex flex-column gap-3">
                @if (!string.IsNullOrEmpty(_product.CategoryName))
                {
                    <span class="badge text-bg-primary align-self-start">
                        <i class="bi bi-grid me-1"></i> @_product.CategoryName
                    </span>
                }

                <h3 class="fw-bold text-primary">@_product.Price.ToString("C2")</h3>

                <div class="d-flex gap-2 align-items-center">
                    @if (_product.Stock > 0)
                    {
                        <span class="badge text-bg-success">
                            <i class="bi bi-check-circle me-1"></i> In Stock (@_product.Stock available)
                        </span>
                    }
                    else
                    {
                        <span class="badge text-bg-danger">
                            <i class="bi bi-x-circle me-1"></i> Out of Stock
                        </span>
                    }
                    @if (!_product.IsActive)
                    {
                        <span class="badge text-bg-warning">Inactive</span>
                    }
                </div>

                @if (!string.IsNullOrEmpty(_product.Description))
                {
                    <hr />
                    <h6 class="fw-semibold">Description</h6>
                    <p>@_product.Description</p>
                }

                <hr />
                <a href="/products" class="text-decoration-none">
                    <i class="bi bi-arrow-left me-1"></i> Back to Products
                </a>
            </div>
        </div>
    </div>

    <ConfirmDialog Visible="_showDeleteConfirm"
                   Title="Delete Product"
                   ContentText="@($"Are you sure you want to delete \"{_product.Name}\"? This action cannot be undone.")"
                   ButtonText="Delete"
                   OnConfirm="ConfirmDelete"
                   OnCancel="@(() => _showDeleteConfirm = false)" />
}

@code {
    private ProductDto? _product;
    private bool _notFound;
    private bool _showDeleteConfirm;

    /// <summary>
    /// The product identifier from the route.
    /// </summary>
    [Parameter]
    public Guid Id { get; set; }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        _product = await ProductApi.GetById(Id, CancellationToken.None);
        if (_product is null)
        {
            _notFound = true;
        }
    }

    private async Task ConfirmDelete()
    {
        _showDeleteConfirm = false;
        var success = await ProductApi.Delete(_product!.Id, CancellationToken.None);
        if (success)
        {
            ToastService.Show("Product deleted successfully", ToastLevel.Success);
            Navigation.NavigateTo("/products");
        }
        else
        {
            ToastService.Show("Failed to delete product", ToastLevel.Error);
        }
    }
}
