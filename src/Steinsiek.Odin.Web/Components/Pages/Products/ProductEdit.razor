@page "/products/{Id:guid}/edit"
@attribute [Authorize]
@inject IProductApiClient ProductApi
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Edit Product - Odin</PageTitle>

@if (_initialData is null && !_notFound)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_notFound)
{
    <div class="text-center py-5">
        <i class="bi bi-exclamation-circle text-danger fs-1 mb-3 d-block"></i>
        <h5>Product not found</h5>
        <a href="/products" class="btn btn-primary mt-3">Back to Products</a>
    </div>
}
else
{
    <PageHeader Title="@($"Edit: {_initialData!.Name}")">
        <Actions>
            <a href="/products/@Id" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
        </Actions>
    </PageHeader>

    <div class="card" style="max-width: 800px;">
        <div class="card-body p-4">
            <ProductForm InitialData="@_initialData"
                         ShowIsActive="true"
                         SubmitText="Update Product"
                         IsSubmitting="@_isSubmitting"
                         OnSubmit="@HandleUpdate"
                         OnCancel="@(() => Navigation.NavigateTo($"/products/{Id}"))" />
        </div>
    </div>
}

@code {
    private ProductFormData? _initialData;
    private bool _notFound;
    private bool _isSubmitting;

    /// <summary>
    /// The product identifier from the route.
    /// </summary>
    [Parameter]
    public Guid Id { get; set; }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        var product = await ProductApi.GetById(Id, CancellationToken.None);
        if (product is null)
        {
            _notFound = true;
            return;
        }

        _initialData = new ProductFormData
        {
            Name = product.Name,
            Description = product.Description,
            Price = product.Price,
            Stock = product.Stock,
            ImageUrl = product.ImageUrl,
            CategoryId = product.CategoryId,
            IsActive = product.IsActive
        };
    }

    private async Task HandleUpdate(ProductFormData data)
    {
        _isSubmitting = true;

        var request = new UpdateProductRequest
        {
            Name = data.Name,
            Description = data.Description,
            Price = data.Price,
            Stock = data.Stock,
            ImageUrl = data.ImageUrl,
            CategoryId = data.CategoryId,
            IsActive = data.IsActive
        };

        var result = await ProductApi.Update(Id, request, CancellationToken.None);

        if (result is not null)
        {
            ToastService.Show("Product updated successfully", ToastLevel.Success);
            Navigation.NavigateTo($"/products/{Id}");
        }
        else
        {
            ToastService.Show("Failed to update product", ToastLevel.Error);
        }

        _isSubmitting = false;
    }
}
