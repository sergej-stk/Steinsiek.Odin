@page "/companies/create"
@attribute [Authorize(Roles = OdinRoles.AdminOrManager)]
@inject ICompanyApiClient CompanyApi
@inject NavigationManager Navigation
@inject IToastService Toast

<PageTitle>Create Company - Odin</PageTitle>

<PageHeader Title="Create Company" Subtitle="Add a new company to the system">
    <Actions>
        <a href="/companies" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Back
        </a>
    </Actions>
</PageHeader>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <EditForm Model="@_request" OnValidSubmit="HandleSubmit" FormName="createCompany">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" />

                    <h6 class="fw-bold mb-3">General Information</h6>

                    <div class="mb-3">
                        <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                        <InputText id="name" class="form-control" @bind-Value="_request.Name" />
                        <ValidationMessage For="@(() => _request.Name)" class="text-danger small" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="website" class="form-label">Website</label>
                            <InputText id="website" class="form-control" @bind-Value="_request.Website" />
                            <ValidationMessage For="@(() => _request.Website)" class="text-danger small" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <InputText id="email" class="form-control" @bind-Value="_request.Email" />
                            <ValidationMessage For="@(() => _request.Email)" class="text-danger small" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone</label>
                        <InputText id="phone" class="form-control" @bind-Value="_request.Phone" />
                        <ValidationMessage For="@(() => _request.Phone)" class="text-danger small" />
                    </div>

                    <hr class="my-4" />
                    <h6 class="fw-bold mb-3">Business Details</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taxNumber" class="form-label">Tax Number</label>
                            <InputText id="taxNumber" class="form-control" @bind-Value="_request.TaxNumber" />
                            <ValidationMessage For="@(() => _request.TaxNumber)" class="text-danger small" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="vatId" class="form-label">VAT ID</label>
                            <InputText id="vatId" class="form-control" @bind-Value="_request.VatId" />
                            <ValidationMessage For="@(() => _request.VatId)" class="text-danger small" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="commercialRegister" class="form-label">Commercial Register Number</label>
                        <InputText id="commercialRegister" class="form-control" @bind-Value="_request.CommercialRegisterNumber" />
                        <ValidationMessage For="@(() => _request.CommercialRegisterNumber)" class="text-danger small" />
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="foundingDate" class="form-label">Founding Date</label>
                            <InputDate id="foundingDate" class="form-control" @bind-Value="_foundingDate" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="employeeCount" class="form-label">Employee Count</label>
                            <InputNumber id="employeeCount" class="form-control" @bind-Value="_employeeCount" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="revenue" class="form-label">Revenue</label>
                            <InputNumber id="revenue" class="form-control" @bind-Value="_revenue" />
                        </div>
                    </div>

                    <hr class="my-4" />
                    <h6 class="fw-bold mb-3">Additional Information</h6>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <InputTextArea id="notes" class="form-control" rows="4" @bind-Value="_request.Notes" />
                        <ValidationMessage For="@(() => _request.Notes)" class="text-danger small" />
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="/companies" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary" disabled="@_submitting">
                            @if (_submitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            <i class="bi bi-check-lg me-1"></i> Create Company
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    /// <summary>
    /// The form model for creating a company.
    /// </summary>
    private CreateCompanyFormModel _request = new();

    /// <summary>
    /// The founding date bound to the date input.
    /// </summary>
    private DateTime? _foundingDate;

    /// <summary>
    /// The employee count bound to the number input.
    /// </summary>
    private int? _employeeCount;

    /// <summary>
    /// The revenue bound to the number input.
    /// </summary>
    private decimal? _revenue;

    /// <summary>
    /// Whether the form is currently being submitted.
    /// </summary>
    private bool _submitting;

    /// <summary>
    /// Handles valid form submission by calling the API.
    /// </summary>
    private async Task HandleSubmit()
    {
        _submitting = true;

        var request = new CreateCompanyRequest
        {
            Name = _request.Name,
            Website = _request.Website,
            Email = _request.Email,
            Phone = _request.Phone,
            TaxNumber = _request.TaxNumber,
            VatId = _request.VatId,
            CommercialRegisterNumber = _request.CommercialRegisterNumber,
            FoundingDate = _foundingDate,
            EmployeeCount = _employeeCount,
            Revenue = _revenue,
            Notes = _request.Notes
        };

        var result = await CompanyApi.Create(request, CancellationToken.None);

        if (result is not null)
        {
            Toast.Show("Company created successfully.", ToastLevel.Success);
            Navigation.NavigateTo($"/companies/{result.Id}");
        }
        else
        {
            Toast.Show("Failed to create company. Please try again.", ToastLevel.Error);
            _submitting = false;
        }
    }

    /// <summary>
    /// Mutable form model for the create company form. Uses a class because EditForm requires mutable properties.
    /// </summary>
    private sealed class CreateCompanyFormModel
    {
        /// <summary>
        /// The company name.
        /// </summary>
        [Required, MaxLength(200)]
        public string Name { get; set; } = "";

        /// <summary>
        /// The company website URL.
        /// </summary>
        [MaxLength(256)]
        public string? Website { get; set; }

        /// <summary>
        /// The company email address.
        /// </summary>
        [MaxLength(256), EmailAddress]
        public string? Email { get; set; }

        /// <summary>
        /// The company phone number.
        /// </summary>
        [MaxLength(256)]
        public string? Phone { get; set; }

        /// <summary>
        /// The company tax number.
        /// </summary>
        [MaxLength(100)]
        public string? TaxNumber { get; set; }

        /// <summary>
        /// The company VAT identification number.
        /// </summary>
        [MaxLength(100)]
        public string? VatId { get; set; }

        /// <summary>
        /// The commercial register number.
        /// </summary>
        [MaxLength(100)]
        public string? CommercialRegisterNumber { get; set; }

        /// <summary>
        /// Additional notes about the company.
        /// </summary>
        [MaxLength(2000)]
        public string? Notes { get; set; }
    }
}
