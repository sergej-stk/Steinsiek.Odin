@page "/companies/{Id:guid}"
@attribute [Authorize]
@inject ICompanyApiClient CompanyApi
@inject NavigationManager Navigation
@inject IToastService Toast

<PageTitle>Company Details - Odin</PageTitle>

@if (_loading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_company is null)
{
    <div class="alert alert-danger">
        Company not found or failed to load.
        <a href="/companies" class="alert-link">Back to Companies</a>
    </div>
}
else
{
    <PageHeader Title="@_company.Name">
        <Actions>
            <div class="d-flex gap-2">
                <a href="/companies" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </a>
                <AuthorizeView Roles="Admin,Manager">
                    <Authorized>
                        <a href="/companies/@Id/edit" class="btn btn-primary btn-sm">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>
                        <button class="btn btn-danger btn-sm" @onclick="ShowDeleteConfirmation">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </Authorized>
                </AuthorizeView>
            </div>
        </Actions>
    </PageHeader>

    <TabPanel Tabs="@_tabs" @bind-ActiveTab="_activeTab" />

    <ConfirmDialog Visible="@_showDeleteConfirm"
                   Title="Delete Company"
                   ContentText="@($"Are you sure you want to delete \"{_company.Name}\"? This action cannot be undone.")"
                   ButtonText="Delete"
                   OnConfirm="HandleDelete"
                   OnCancel="HideDeleteConfirmation" />
}

@code {
    /// <summary>
    /// The company identifier from the route parameter.
    /// </summary>
    [Parameter]
    public Guid Id { get; set; }

    /// <summary>
    /// The loaded company detail data.
    /// </summary>
    private CompanyDetailDto? _company;

    /// <summary>
    /// Whether the page is currently loading data.
    /// </summary>
    private bool _loading = true;

    /// <summary>
    /// The tab items for the tab panel.
    /// </summary>
    private List<TabItem> _tabs = [];

    /// <summary>
    /// The currently active tab index.
    /// </summary>
    private int _activeTab;

    /// <summary>
    /// Whether the delete confirmation dialog is visible.
    /// </summary>
    private bool _showDeleteConfirm;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        _company = await CompanyApi.GetById(Id, CancellationToken.None);
        _loading = false;

        if (_company is not null)
        {
            BuildTabs();
        }
    }

    /// <summary>
    /// Builds the tab items for the tab panel based on the loaded company data.
    /// </summary>
    private void BuildTabs()
    {
        _tabs =
        [
            new TabItem
            {
                Title = "Overview",
                Icon = "bi-building",
                Content = RenderOverviewTab()
            },
            new TabItem
            {
                Title = "Locations",
                Icon = "bi-geo-alt",
                Badge = _company!.Locations.Count,
                Content = RenderLocationsTab()
            },
            new TabItem
            {
                Title = "Employees",
                Icon = "bi-people",
                Badge = _company.PersonCompanies.Count,
                Content = RenderEmployeesTab()
            }
        ];
    }

    /// <summary>
    /// Renders the overview tab content with company details.
    /// </summary>
    private RenderFragment RenderOverviewTab() => __builder =>
    {
        <div class="row">
            <div class="col-md-6">
                <DetailCard Title="General Information" Icon="bi-info-circle">
                    <DetailField Label="Name" Value="@_company!.Name" />
                    <DetailField Label="Website" Value="@_company.Website" />
                    <DetailField Label="Email" Value="@_company.Email" />
                    <DetailField Label="Phone" Value="@_company.Phone" />
                </DetailCard>
            </div>
            <div class="col-md-6">
                <DetailCard Title="Business Details" Icon="bi-briefcase">
                    <DetailField Label="Tax Number" Value="@_company!.TaxNumber" />
                    <DetailField Label="VAT ID" Value="@_company.VatId" />
                    <DetailField Label="Commercial Register" Value="@_company.CommercialRegisterNumber" />
                    <DetailField Label="Founding Date" Value="@_company.FoundingDate?.ToString("yyyy-MM-dd")" />
                    <DetailField Label="Employees" Value="@_company.EmployeeCount?.ToString()" />
                    <DetailField Label="Revenue" Value="@(_company.Revenue?.ToString("C"))" />
                </DetailCard>
            </div>
        </div>
        @if (!string.IsNullOrEmpty(_company!.Notes))
        {
            <DetailCard Title="Notes" Icon="bi-journal-text">
                <p class="mb-0">@_company.Notes</p>
            </DetailCard>
        }
    };

    /// <summary>
    /// Renders the locations tab content with a table of company locations.
    /// </summary>
    private RenderFragment RenderLocationsTab() => __builder =>
    {
        @if (!_company!.Locations.Any())
        {
            <div class="text-center py-4 text-muted">
                <i class="bi bi-geo-alt fs-3 d-block mb-2"></i>
                <p>No locations found for this company.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Street</th>
                            <th>City</th>
                            <th>Postal Code</th>
                            <th>State</th>
                            <th>Primary</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var location in _company.Locations)
                        {
                            <tr>
                                <td class="fw-medium">@location.Name</td>
                                <td>@location.Street</td>
                                <td>@location.City</td>
                                <td>@location.PostalCode</td>
                                <td>@(location.State ?? "\u2014")</td>
                                <td>
                                    @if (location.IsPrimary)
                                    {
                                        <span class="badge bg-success">Primary</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Renders the employees tab content with a table of person-company associations.
    /// </summary>
    private RenderFragment RenderEmployeesTab() => __builder =>
    {
        @if (!_company!.PersonCompanies.Any())
        {
            <div class="text-center py-4 text-muted">
                <i class="bi bi-people fs-3 d-block mb-2"></i>
                <p>No employees associated with this company.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Person ID</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pc in _company.PersonCompanies)
                        {
                            <tr>
                                <td class="font-monospace small">@pc.PersonId</td>
                                <td>@(pc.StartDate?.ToString("yyyy-MM-dd") ?? "\u2014")</td>
                                <td>@(pc.EndDate?.ToString("yyyy-MM-dd") ?? "\u2014")</td>
                                <td>
                                    @if (pc.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Shows the delete confirmation dialog.
    /// </summary>
    private void ShowDeleteConfirmation()
    {
        _showDeleteConfirm = true;
    }

    /// <summary>
    /// Hides the delete confirmation dialog.
    /// </summary>
    private void HideDeleteConfirmation()
    {
        _showDeleteConfirm = false;
    }

    /// <summary>
    /// Handles the delete confirmation by calling the API and navigating back to the list.
    /// </summary>
    private async Task HandleDelete()
    {
        _showDeleteConfirm = false;

        var success = await CompanyApi.Delete(Id, CancellationToken.None);
        if (success)
        {
            Toast.Show("Company deleted successfully.", ToastLevel.Success);
            Navigation.NavigateTo("/companies");
        }
        else
        {
            Toast.Show("Failed to delete company. Please try again.", ToastLevel.Error);
        }
    }
}
