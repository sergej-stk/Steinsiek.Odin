@inject ILookupApiClient LookupApi

@if (Visible)
{
    <div class="offcanvas-backdrop fade show" @onclick="Close"></div>
    <div class="offcanvas offcanvas-end show" tabindex="-1">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Filter Persons</h5>
            <button type="button" class="btn-close" @onclick="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label class="form-label">City</label>
                <input type="text" class="form-control" @bind="_city" placeholder="Filter by city..." />
            </div>

            <LookupSelect Label="Salutation" Items="_salutations" Value="_salutationId" ValueChanged="v => _salutationId = v" />
            <LookupSelect Label="Gender" Items="_genders" Value="_genderId" ValueChanged="v => _genderId = v" />
            <LookupSelect Label="Nationality" Items="_countries" Value="_nationalityId" ValueChanged="v => _nationalityId = v" />
            <LookupSelect Label="Marital Status" Items="_maritalStatuses" Value="_maritalStatusId" ValueChanged="v => _maritalStatusId = v" />

            <div class="mb-3">
                <label class="form-label">Created from</label>
                <input type="date" class="form-control" @bind="_createdFrom" />
            </div>
            <div class="mb-3">
                <label class="form-label">Created to</label>
                <input type="date" class="form-control" @bind="_createdTo" />
            </div>
        </div>
        <div class="offcanvas-footer p-3 border-top d-flex gap-2">
            <button class="btn btn-primary flex-fill" @onclick="Apply">Apply</button>
            <button class="btn btn-outline-secondary flex-fill" @onclick="ClearAll">Clear all</button>
        </div>
    </div>
}

@code {
    /// <summary>
    /// Whether the filter panel is visible.
    /// </summary>
    [Parameter]
    public bool Visible { get; set; }

    /// <summary>
    /// Callback when the panel visibility changes.
    /// </summary>
    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    /// <summary>
    /// The current filter values.
    /// </summary>
    [Parameter]
    public PersonFilterQuery? Filter { get; set; }

    /// <summary>
    /// Callback when filters are applied.
    /// </summary>
    [Parameter]
    public EventCallback<PersonFilterQuery> OnApply { get; set; }

    private IReadOnlyList<LookupDto>? _salutations;
    private IReadOnlyList<LookupDto>? _genders;
    private IReadOnlyList<LookupDto>? _countries;
    private IReadOnlyList<LookupDto>? _maritalStatuses;

    private string? _city;
    private Guid? _salutationId;
    private Guid? _genderId;
    private Guid? _nationalityId;
    private Guid? _maritalStatusId;
    private DateTime? _createdFrom;
    private DateTime? _createdTo;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        var cts = CancellationToken.None;
        _salutations = await LookupApi.GetByType("salutations", cts);
        _genders = await LookupApi.GetByType("genders", cts);
        _countries = await LookupApi.GetByType("countries", cts);
        _maritalStatuses = await LookupApi.GetByType("maritalstatuses", cts);
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
        if (Filter is not null)
        {
            _city = Filter.City;
            _salutationId = Filter.SalutationId;
            _genderId = Filter.GenderId;
            _nationalityId = Filter.NationalityId;
            _maritalStatusId = Filter.MaritalStatusId;
            _createdFrom = Filter.CreatedFrom;
            _createdTo = Filter.CreatedTo;
        }
    }

    private async Task Apply()
    {
        var filter = new PersonFilterQuery
        {
            City = _city,
            SalutationId = _salutationId,
            GenderId = _genderId,
            NationalityId = _nationalityId,
            MaritalStatusId = _maritalStatusId,
            CreatedFrom = _createdFrom,
            CreatedTo = _createdTo
        };

        await OnApply.InvokeAsync(filter);
        await VisibleChanged.InvokeAsync(false);
    }

    private async Task ClearAll()
    {
        _city = null;
        _salutationId = null;
        _genderId = null;
        _nationalityId = null;
        _maritalStatusId = null;
        _createdFrom = null;
        _createdTo = null;

        await OnApply.InvokeAsync(new PersonFilterQuery());
        await VisibleChanged.InvokeAsync(false);
    }

    private async Task Close()
    {
        await VisibleChanged.InvokeAsync(false);
    }
}
