@page "/persons/{Id:guid}"
@attribute [Authorize]
@inject IPersonApiClient PersonApi
@inject NavigationManager Navigation
@inject IToastService Toast

<PageTitle>Person Detail - Odin</PageTitle>

@if (_person is null && !_error)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_error)
{
    <div class="alert alert-danger mb-4">
        Failed to load person details. Please try again later.
    </div>
}
else if (_person is not null)
{
    <PageHeader Title="@_person.FullName" Subtitle="Person details">
        <Actions>
            <AuthorizeView Roles="Admin,Manager">
                <Authorized>
                    <div class="d-flex gap-2">
                        <a href="/persons/@Id/edit" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>
                        <button class="btn btn-outline-danger btn-sm" @onclick="ShowDeleteConfirm">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </div>
                </Authorized>
            </AuthorizeView>
        </Actions>
    </PageHeader>

    <TabPanel Tabs="_tabs" />

    <ConfirmDialog Visible="_showDeleteConfirm"
                   Title="Delete Person"
                   ContentText="@($"Are you sure you want to delete {_person.FullName}? This action cannot be undone.")"
                   ButtonText="Delete"
                   OnConfirm="HandleDelete"
                   OnCancel="HideDeleteConfirm" />
}

@code {
    /// <summary>
    /// The person identifier from the route parameter.
    /// </summary>
    [Parameter]
    public Guid Id { get; set; }

    private PersonDetailDto? _person;
    private bool _error;
    private bool _showDeleteConfirm;
    private List<TabItem> _tabs = [];

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        _person = await PersonApi.GetById(Id, CancellationToken.None);
        if (_person is null)
        {
            _error = true;
            return;
        }

        BuildTabs();
    }

    /// <summary>
    /// Builds the tab items for the TabPanel based on loaded person data.
    /// </summary>
    private void BuildTabs()
    {
        if (_person is null) return;

        _tabs =
        [
            new TabItem
            {
                Title = "Overview",
                Icon = "bi-person",
                Content = RenderOverviewTab()
            },
            new TabItem
            {
                Title = "Addresses",
                Icon = "bi-geo-alt",
                Badge = _person.Addresses.Count,
                Content = RenderAddressesTab()
            },
            new TabItem
            {
                Title = "Contacts",
                Icon = "bi-telephone",
                Badge = _person.EmailAddresses.Count + _person.PhoneNumbers.Count,
                Content = RenderContactsTab()
            },
            new TabItem
            {
                Title = "Bank Accounts",
                Icon = "bi-bank",
                Badge = _person.BankAccounts.Count,
                Content = RenderBankAccountsTab()
            },
            new TabItem
            {
                Title = "Social Media",
                Icon = "bi-share",
                Badge = _person.SocialMediaLinks.Count,
                Content = RenderSocialMediaTab()
            }
        ];
    }

    /// <summary>
    /// Renders the overview tab content with personal information fields.
    /// </summary>
    private RenderFragment RenderOverviewTab() => __builder =>
    {
        <DetailCard Title="Personal Information" Icon="bi-person-vcard">
            <DetailField Label="Title" Value="@_person!.Title" />
            <DetailField Label="First Name" Value="@_person!.FirstName" />
            <DetailField Label="Last Name" Value="@_person!.LastName" />
            <DetailField Label="Date of Birth" Value="@(_person!.DateOfBirth?.ToString("yyyy-MM-dd"))" />
            <DetailField Label="Notes" Value="@_person!.Notes" />
        </DetailCard>
        <DetailCard Title="System Information" Icon="bi-info-circle">
            <DetailField Label="Created" Value="@_person!.CreatedAt.ToString("yyyy-MM-dd HH:mm")" />
            <DetailField Label="Last Updated" Value="@(_person!.UpdatedAt?.ToString("yyyy-MM-dd HH:mm"))" />
        </DetailCard>
    };

    /// <summary>
    /// Renders the addresses tab content.
    /// </summary>
    private RenderFragment RenderAddressesTab() => __builder =>
    {
        if (!_person!.Addresses.Any())
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-geo-alt fs-3 d-block mb-2"></i>
                No addresses found
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Street</th>
                            <th>City</th>
                            <th>Postal Code</th>
                            <th>State</th>
                            <th>Primary</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var address in _person.Addresses)
                        {
                            <tr>
                                <td>@address.Street @address.Street2</td>
                                <td>@address.City</td>
                                <td>@address.PostalCode</td>
                                <td>@(address.State ?? "\u2014")</td>
                                <td>
                                    @if (address.IsPrimary)
                                    {
                                        <span class="badge bg-primary">Primary</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Renders the contacts tab content with emails and phone numbers.
    /// </summary>
    private RenderFragment RenderContactsTab() => __builder =>
    {
        <h6 class="fw-bold mb-3"><i class="bi bi-envelope me-2"></i>Email Addresses</h6>
        if (!_person!.EmailAddresses.Any())
        {
            <div class="text-center text-muted py-3 mb-4">
                <i class="bi bi-envelope fs-4 d-block mb-2"></i>
                No email addresses found
            </div>
        }
        else
        {
            <div class="table-responsive mb-4">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Label</th>
                            <th>Primary</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var email in _person.EmailAddresses)
                        {
                            <tr>
                                <td>@email.Email</td>
                                <td>@(email.Label ?? "\u2014")</td>
                                <td>
                                    @if (email.IsPrimary)
                                    {
                                        <span class="badge bg-primary">Primary</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <h6 class="fw-bold mb-3"><i class="bi bi-telephone me-2"></i>Phone Numbers</h6>
        if (!_person.PhoneNumbers.Any())
        {
            <div class="text-center text-muted py-3">
                <i class="bi bi-telephone fs-4 d-block mb-2"></i>
                No phone numbers found
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Number</th>
                            <th>Label</th>
                            <th>Primary</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var phone in _person.PhoneNumbers)
                        {
                            <tr>
                                <td>@phone.Number</td>
                                <td>@(phone.Label ?? "\u2014")</td>
                                <td>
                                    @if (phone.IsPrimary)
                                    {
                                        <span class="badge bg-primary">Primary</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Renders the bank accounts tab content.
    /// </summary>
    private RenderFragment RenderBankAccountsTab() => __builder =>
    {
        if (!_person!.BankAccounts.Any())
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-bank fs-3 d-block mb-2"></i>
                No bank accounts found
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>IBAN</th>
                            <th>BIC</th>
                            <th>Bank Name</th>
                            <th>Label</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var account in _person.BankAccounts)
                        {
                            <tr>
                                <td class="font-monospace">@account.Iban</td>
                                <td>@(account.Bic ?? "\u2014")</td>
                                <td>@(account.BankName ?? "\u2014")</td>
                                <td>@(account.Label ?? "\u2014")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Renders the social media tab content.
    /// </summary>
    private RenderFragment RenderSocialMediaTab() => __builder =>
    {
        if (!_person!.SocialMediaLinks.Any())
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-share fs-3 d-block mb-2"></i>
                No social media links found
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Platform</th>
                            <th>URL</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var link in _person.SocialMediaLinks)
                        {
                            <tr>
                                <td>@link.Platform</td>
                                <td>
                                    <a href="@link.Url" target="_blank" rel="noopener noreferrer">
                                        @link.Url <i class="bi bi-box-arrow-up-right ms-1"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    };

    /// <summary>
    /// Shows the delete confirmation dialog.
    /// </summary>
    private void ShowDeleteConfirm()
    {
        _showDeleteConfirm = true;
    }

    /// <summary>
    /// Hides the delete confirmation dialog.
    /// </summary>
    private void HideDeleteConfirm()
    {
        _showDeleteConfirm = false;
    }

    /// <summary>
    /// Handles the confirmed delete action by calling the API and navigating back to the list.
    /// </summary>
    private async Task HandleDelete()
    {
        _showDeleteConfirm = false;
        var success = await PersonApi.Delete(Id, CancellationToken.None);
        if (success)
        {
            Toast.Show("Person deleted successfully.", ToastLevel.Success);
            Navigation.NavigateTo("/persons");
        }
        else
        {
            Toast.Show("Failed to delete person.", ToastLevel.Error);
        }
    }
}
