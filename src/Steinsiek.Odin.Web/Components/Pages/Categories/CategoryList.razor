@page "/categories"
@inject ICategoryApiClient CategoryApi
@inject IToastService ToastService

<PageTitle>Categories - Odin</PageTitle>

<PageHeader Title="Categories" Subtitle="Manage product categories">
    <Actions>
        <AuthorizeView>
            <Authorized>
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    <i class="bi bi-plus-lg me-1"></i> New Category
                </button>
            </Authorized>
        </AuthorizeView>
    </Actions>
</PageHeader>

@if (_categories is null)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Products</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var category in _categories.Data)
                {
                    <tr>
                        <td>@category.Name</td>
                        <td>@category.Description</td>
                        <td>
                            @if (category.IsActive)
                            {
                                <span class="badge text-bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge text-bg-secondary">Inactive</span>
                            }
                        </td>
                        <td>
                            <a href="/products?category=@category.Id" class="btn btn-link btn-sm p-0">View Products</a>
                        </td>
                        <td class="text-end">
                            <AuthorizeView>
                                <Authorized Context="auth">
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="@(() => OpenEditDialog(category))">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="@(() => OpenDeleteConfirm(category))">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </Authorized>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<CategoryFormDialog Visible="_showFormDialog"
                    IsEdit="_formIsEdit"
                    CategoryId="_formCategoryId"
                    Name="@_formName"
                    Description="@_formDescription"
                    IsActive="_formIsActive"
                    OnClose="HandleFormClose" />

<ConfirmDialog Visible="_showDeleteConfirm"
               Title="Delete Category"
               ContentText="@($"Are you sure you want to delete \"{_deleteCategoryName}\"?")"
               ButtonText="Delete"
               OnConfirm="ConfirmDelete"
               OnCancel="@(() => _showDeleteConfirm = false)" />

@code {
    private ListResult<CategoryDto>? _categories;

    private bool _showFormDialog;
    private bool _formIsEdit;
    private Guid _formCategoryId;
    private string _formName = string.Empty;
    private string? _formDescription;
    private bool _formIsActive = true;

    private bool _showDeleteConfirm;
    private Guid _deleteCategoryId;
    private string _deleteCategoryName = string.Empty;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        _categories = await CategoryApi.GetAll(CancellationToken.None);
    }

    private void OpenCreateDialog()
    {
        _formIsEdit = false;
        _formCategoryId = Guid.Empty;
        _formName = string.Empty;
        _formDescription = null;
        _formIsActive = true;
        _showFormDialog = true;
    }

    private void OpenEditDialog(CategoryDto category)
    {
        _formIsEdit = true;
        _formCategoryId = category.Id;
        _formName = category.Name;
        _formDescription = category.Description;
        _formIsActive = category.IsActive;
        _showFormDialog = true;
    }

    private async Task HandleFormClose(bool success)
    {
        _showFormDialog = false;
        if (success)
        {
            await LoadCategories();
            ToastService.Show(
                _formIsEdit ? "Category updated successfully" : "Category created successfully",
                ToastLevel.Success);
        }
    }

    private void OpenDeleteConfirm(CategoryDto category)
    {
        _deleteCategoryId = category.Id;
        _deleteCategoryName = category.Name;
        _showDeleteConfirm = true;
    }

    private async Task ConfirmDelete()
    {
        _showDeleteConfirm = false;
        var success = await CategoryApi.Delete(_deleteCategoryId, CancellationToken.None);
        if (success)
        {
            await LoadCategories();
            ToastService.Show("Category deleted successfully", ToastLevel.Success);
        }
        else
        {
            ToastService.Show("Failed to delete category", ToastLevel.Error);
        }
    }
}
